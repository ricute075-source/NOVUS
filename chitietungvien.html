<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chi ti·∫øt h·ªì s∆° ·ª©ng vi√™n</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="./CSS/main.css" />
    <link rel="stylesheet" href="CSS/phanbodytrangchu.css" />
    
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f4f5f7;
        color: #333;
      }

      .container {
        max-width: 900px;
        margin: 40px auto;
        padding: 0 20px;
      }

      .profile-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        overflow: hidden;
      }

      .card-header {
        background: linear-gradient(135deg, #CBEEFF 0%, #5AC9FF 100%);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
      }
      .card-header h1 { margin: 0; font-size: 24px; font-weight: 700; }
      .card-header p { margin: 10px 0 0; opacity: 0.9; font-size: 16px; }
      
      .status-tag {
        display: inline-block;
        background: rgba(255,255,255,0.25);
        padding: 6px 18px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        margin-top: 15px;
        border: 1px solid rgba(255,255,255,0.3);
      }

      .card-body { padding: 40px; }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .info-item h3 {
        font-size: 14px;
        color: #888;
        text-transform: uppercase;
        margin-bottom: 8px;
        font-weight: 600;
      }
      .info-item p {
        font-size: 18px;
        font-weight: 500;
        color: #111;
        margin: 0;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }

      .full-width { grid-column: 1 / -1; }

      .cover-letter {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #5AC9FF;
        line-height: 1.6;
        white-space: pre-wrap;
      }

      .cv-preview {
        display: flex;
        align-items: center;
        gap: 15px;
        background: #eefbf3;
        padding: 15px;
        border-radius: 8px;
        border: 1px dashed #5AC9FF;
        margin-top: 10px;
      }
      .cv-icon { width: 40px; height: 40px; }
      
      .action-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-top: 40px;
        border-top: 1px solid #eee;
        padding-top: 30px;
      }

      button {
        padding: 12px 24px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        font-size: 16px;
      }
      
      .btn-back { background: #e0e0e0; color: #333; }
      .btn-reject { background: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; }
      .btn-approve { background: #5AC9FF; color: white; box-shadow: 0 4px 10px #1ba0f4; }

      button:hover { transform: translateY(-2px); opacity: 0.9; }
      button:active { transform: translateY(0); }
      .btn-reject:hover { background: #ffCDD2; }

      .hidden { display: none !important; }

      @media (max-width: 600px) {
        .info-grid { grid-template-columns: 1fr; }
        .action-buttons { flex-direction: column; }
        button { width: 100%; }
      }
    </style>
  </head>

  <body>
    <header></header>
    <script src="./JS/header.js"></script>

    <div class="container">
      <div class="profile-card">
        
        <div class="card-header" id="headerBg">
          <h1 id="uvName">ƒêang t·∫£i d·ªØ li·ªáu...</h1>
          <p>·ª®ng tuy·ªÉn v·ªã tr√≠: <strong id="jobTitle">...</strong></p>
          <div class="status-tag" id="statusTag">Ch·ªù duy·ªát</div>
        </div>

        <div class="card-body">
          
          <div class="info-grid">
            <div class="info-item">
              <h3>Email li√™n h·ªá</h3>
              <p id="uvEmail">...</p>
            </div>
            <div class="info-item">
              <h3>S·ªë ƒëi·ªán tho·∫°i<br>(vui l√≤ng g·ªçi trao ƒë·ªïi v·ªõi ·ª©ng vi√™n)</h3>
              <p id="uvPhone">...</p>
            </div>
            <div class="info-item">
              <h3>Th·ªùi gian n·ªôp</h3>
              <p id="submitTime">...</p>
            </div>
            <div class="info-item">
              <h3>C√¥ng ty ·ª©ng tuy·ªÉn</h3>
              <p id="companyName">...</p>
            </div>
            


            <div class="info-item full-width">
              <h3>Th∆∞ gi·ªõi thi·ªáu</h3>
              <div class="cover-letter" id="uvCover">
                (Kh√¥ng c√≥ th∆∞ gi·ªõi thi·ªáu)
              </div>
            </div>
          </div>

          <div class="action-buttons" id="actionBtns">
            <button class="btn-back" onclick="window.history.back()">‚Üê Quay l·∫°i</button>
            <button class="btn-reject" id="btnReject" onclick="xuLyHoSo('TuChoi')">T·ª´ ch·ªëi h·ªì s∆°</button>
            <button class="btn-approve" id="btnApprove" onclick="xuLyHoSo('Duyet')">‚úì Duy·ªát h·ªì s∆° & H·∫πn ph·ªèng v·∫•n</button>
          </div>

        </div>
      </div>
    </div>

    <footer></footer>
    <script src="./JS/footer.js"></script>

<script>
  // --- BI·∫æN TO√ÄN C·ª§C ---
  window.currentAppData = null; 

  // L·∫•y tham s·ªë URL
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  // Format ng√†y th√°ng
  function formatDate(isoString) {
    if (!isoString) return "V·ª´a xong";
    try {
        const date = new Date(isoString);
        return date.toLocaleString('vi-VN');
    } catch (e) { return isoString; }
  }

  // --- C·∫¨P NH·∫¨T GIAO DI·ªÜN ---
  function updateUIStatus(status) {
    const tag = document.getElementById("statusTag");
    const header = document.getElementById("headerBg");
    const btnApprove = document.getElementById("btnApprove");
    const btnReject = document.getElementById("btnReject");

    if (status === 'approved') {
        tag.innerText = "ƒê√É DUY·ªÜT H·ªí S∆†";
        tag.style.background = "#4caf50"; 
        header.style.background = "linear-gradient(135deg, #00b14f 0%, #008a3c 100%)";
        btnApprove.classList.add("hidden");
        btnReject.classList.add("hidden");
    } else if (status === 'rejected') {
        tag.innerText = "ƒê√É T·ª™ CH·ªêI";
        tag.style.background = "#d32f2f"; 
        header.style.background = "linear-gradient(135deg, #ff5252 0%, #d32f2f 100%)";
        btnApprove.classList.add("hidden");
        btnReject.classList.add("hidden");
    } else {
        tag.innerText = "CH·ªú DUY·ªÜT";
        tag.style.background = "rgba(255,255,255,0.3)";
        btnApprove.classList.remove("hidden");
        btnReject.classList.remove("hidden");
    }
  }

  // --- KH·ªûI T·∫†O ---
  document.addEventListener("DOMContentLoaded", () => {
    const appId = getQueryParam("id");
    let applications = JSON.parse(localStorage.getItem("applications") || "[]");
    
    if (appId) {
        window.currentAppData = applications.find(a => a.id == appId);
    }

    // D·ªØ li·ªáu Demo
    if (!window.currentAppData) {
        console.warn("Ch·∫ø ƒë·ªô Demo.");
        window.currentAppData = {
            id: "demo", fullname: "Nguy·ªÖn VƒÉn A (Demo)", email: "demo@gmail.com", phone: "0912345678",
            jobTitle: "L·∫≠p tr√¨nh vi√™n", company: "C√¥ng ty Demo", cover: "Em r·∫•t mong ƒë∆∞·ª£c l√†m vi·ªác...",
            time: new Date().toISOString(), cvName: "CV_Mau.pdf", status: 'pending',
            candidateId: 'uv_demo', jobId: 'job_demo', ntdId: 'ADMIN_TEST' 
        };
    }

    const data = window.currentAppData;
    document.getElementById("uvName").innerText = data.fullname;
    document.getElementById("uvEmail").innerText = data.email;
    document.getElementById("uvPhone").innerText = data.phone;
    document.getElementById("jobTitle").innerText = data.jobTitle;
    document.getElementById("companyName").innerText = data.company;
    document.getElementById("submitTime").innerText = formatDate(data.time);
    document.getElementById("uvCover").innerText = data.cover || "(Kh√¥ng c√≥ th∆∞ gi·ªõi thi·ªáu)";
    document.getElementById("cvName").innerText = data.cvName || "cv_file.pdf";

    document.getElementById("cvLink").onclick = (e) => { e.preventDefault(); taiXuongCV(); };
    updateUIStatus(data.status);
  });

  function taiXuongCV() {
    const data = window.currentAppData;
    if(!data) return;
    const noiDung = `CV ·ª®NG VI√äN: ${data.fullname}\nEmail: ${data.email}\nSƒêT: ${data.phone}\n...`;
    const blob = new Blob([noiDung], { type: "text/plain;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "CV_" + data.fullname + ".txt"; 
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }

  // --- H√ÄM G·ª¨I TH√îNG B√ÅO ---
  function addNotificationForUser(recipientId, notif) {
    if (!recipientId) return;
    const key = 'notifs_' + recipientId;
    try {
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      arr.unshift(notif);
      localStorage.setItem(key, JSON.stringify(arr.slice(0, 200)));
      localStorage.setItem('trigger_reload_notif', Date.now().toString());
    } catch (e) { console.warn(e); }
  }

  // --- H√ÄM X√ìA TH√îNG B√ÅO (T√¨m v√† x√≥a) ---
  function xoaThongBaoCu() {
    const data = window.currentAppData;
    let targetId = data.ntdId || localStorage.getItem('currentUserId');
    if (!targetId || targetId === 'null') targetId = "ADMIN_TEST";

    const potentialIds = new Set([targetId, localStorage.getItem('currentUserId'), 'ADMIN_TEST']);
    
    potentialIds.forEach(tId => {
        if(!tId) return;
        const ntdKey = 'notifs_' + tId;
        const storedData = localStorage.getItem(ntdKey);
        if (storedData) {
            let ntdNotifs = JSON.parse(storedData);
            const originalLength = ntdNotifs.length;
            
            // L·ªçc b·ªè th√¥ng b√°o ch·ª©a ID c·ªßa h·ªì s∆° n√†y
            ntdNotifs = ntdNotifs.filter(n => {
                if (n.link && n.link.includes(data.id)) return false;
                if (n.message && n.message.includes(data.fullname) && n.title.includes("H·ªì s∆°")) return false;
                return true;
            });

            if (ntdNotifs.length < originalLength) {
                localStorage.setItem(ntdKey, JSON.stringify(ntdNotifs));
                localStorage.setItem('trigger_reload_notif', Date.now().toString());
                window.dispatchEvent(new Event('storage')); 
            }
        }
    });
  }

  // ============================================================
  // üî• LOGIC X·ª¨ L√ù CH√çNH (ƒê√É LO·∫†I B·ªé POPUP)
  // ============================================================
  function xuLyHoSo(hanhDong) {
    const data = window.currentAppData;
    if (!data) return;
    
    let applications = JSON.parse(localStorage.getItem("applications") || "[]");
    const index = applications.findIndex(a => a.id == data.id);

    // --- TR∆Ø·ªúNG H·ª¢P 1: DUY·ªÜT H·ªí S∆† ---
    if (hanhDong === 'Duyet') {
        if(confirm(`X√°c nh·∫≠n DUY·ªÜT h·ªì s∆° c·ªßa ${data.fullname}?`)) {
            // 1. L∆∞u tr·∫°ng th√°i
            if (index !== -1) {
                applications[index].status = 'approved';
                localStorage.setItem("applications", JSON.stringify(applications));
            }
            updateUIStatus('approved');

            // 2. G·ª≠i th√¥ng b√°o CHO ·ª®NG VI√äN (D·∫°ng tin nh·∫Øn vƒÉn b·∫£n th∆∞·ªùng)
            const sdtHR = "0909.123.456"; 
            
            // Thay v√¨ Popup, ta ghi th·∫≥ng n·ªôi dung v√†o message
            addNotificationForUser(data.candidateId, {
                id: Date.now(),
                title: "‚úÖ H·ªì s∆° ƒë∆∞·ª£c duy·ªát!",
                message: `Ch√∫c m·ª´ng! H·ªì s∆° ${data.jobTitle} c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c duy·ªát. Vui l√≤ng li√™n h·ªá SƒêT: ${sdtHR} (Gi·ªù h√†nh ch√≠nh) ƒë·ªÉ nh·∫≠n l·ªãch ph·ªèng v·∫•n.`,
                time: new Date().toISOString(),
                isRead: false
                // Kh√¥ng c√≥ thu·ªôc t√≠nh 'link' -> Kh√¥ng sinh ra n√∫t b·∫•m
            });

            // 3. X√ìA TH√îNG B√ÅO C·ª¶A NTD
            xoaThongBaoCu();

            alert(`‚úÖ ƒê√£ duy·ªát h·ªì s∆° th√†nh c√¥ng!`);

            // 4. H·ªèi ƒë√≥ng b√†i ƒëƒÉng
            setTimeout(() => {
                if(confirm(`B·∫°n c√≥ mu·ªën ƒê√ìNG (X√ìA) b√†i ƒëƒÉng "${data.jobTitle}" n√†y kh√¥ng?`)) {
                    let jobs = JSON.parse(localStorage.getItem("jobs") || "[]");
                    let initialCount = jobs.length;
                    jobs = jobs.filter(j => j.id !== data.jobId);
                    if (jobs.length < initialCount) {
                        localStorage.setItem("jobs", JSON.stringify(jobs));
                        alert("‚úÖ ƒê√£ ƒë√≥ng b√†i ƒëƒÉng tuy·ªÉn d·ª•ng!");
                        window.location.href = "index.html";
                    }
                }
            }, 500);
        }
    } 
    
    // --- TR∆Ø·ªúNG H·ª¢P 2: T·ª™ CH·ªêI H·ªí S∆† ---
    else if (hanhDong === 'TuChoi') {
        if(confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën T·ª™ CH·ªêI ·ª©ng vi√™n ${data.fullname}?`)) {
            if (index !== -1) {
                applications[index].status = 'rejected';
                localStorage.setItem("applications", JSON.stringify(applications));
            }
            updateUIStatus('rejected');
            
            // G·ª≠i th√¥ng b√°o vƒÉn b·∫£n th∆∞·ªùng
            addNotificationForUser(data.candidateId, {
                id: Date.now(), 
                title: "Th√¥ng b√°o h·ªì s∆°",
                message: `R·∫•t ti·∫øc, h·ªì s∆° v·ªã tr√≠ ${data.jobTitle} c·ªßa b·∫°n ch∆∞a ph√π h·ª£p. Ch√∫ng t√¥i ƒë√£ l∆∞u h·ªì s∆° v√† s·∫Ω li√™n h·ªá khi c√≥ v·ªã tr√≠ kh√°c.`,
                time: new Date().toISOString(), 
                isRead: false
            });

            xoaThongBaoCu();
            
            alert("üö´ ƒê√£ t·ª´ ch·ªëi h·ªì s∆°.");
        }
    }
  }
</script>

    <script src="JS/nhac.js"></script>
    <script src="JS/quanlyvieclam.js"></script>
    <script src="JS/nutbam.js"></script>
    <script src="JS/SuLyDangNhap.js"></script>
    <script src="JS/DangNhapGG.js"></script>
    <script src="JS/SuLyPopup.js"></script>

  </body>
</html>
